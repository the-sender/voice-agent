<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice Agent – Test</title>
<div style="font:14px system-ui;max-width:560px;margin:40px auto;padding:20px;border:1px solid #eee;border-radius:16px">
  <h3 style="margin:0 0 12px">Voice Agent – Test Call</h3>
  <p style="color:#666;margin:0 0 14px">Click Start, speak, and the AI should talk back.</p>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
    <button id="start">Start</button>
    <button id="end" disabled>End</button>
    <span id="status" style="color:#666">idle</span>
  </div>
  <p style="color:#888;margin:8px 0 0">Tip: allow microphone permission when prompted.</p>
</div>
<script>
(async function(){
  const startBtn = document.getElementById("start");
  const endBtn   = document.getElementById("end");
  const statusEl = document.getElementById("status");
  let pc, mic, audioEl;

  async function start() {
    try {
      statusEl.textContent = "requesting mic";
      mic = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true }
      });

      statusEl.textContent = "fetching session";
      const session = await fetch("/api/session", { method: "POST" }).then(r => r.json());
      const EPHEMERAL = session?.client_secret?.value;
      if (!EPHEMERAL) throw new Error("No ephemeral token from /api/session");

      statusEl.textContent = "connecting";
      pc = new RTCPeerConnection();
      audioEl = new Audio(); audioEl.autoplay = true;
      pc.ontrack = (ev) => { audioEl.srcObject = ev.streams[0]; };
      pc.addTrack(mic.getTracks()[0], mic);

      const offer = await pc.createOffer({ offerToReceiveAudio: true });
      await pc.setLocalDescription(offer);

      const rsp = await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview", {
        method: "POST",
        headers: { "Authorization": `Bearer ${EPHEMERAL}`, "Content-Type": "application/sdp" },
        body: offer.sdp
      });

      if (!rsp.ok) throw new Error(await rsp.text());
      await pc.setRemoteDescription({ type: "answer", sdp: await rsp.text() });

      startBtn.disabled = true; endBtn.disabled = false;
      statusEl.textContent = "connected";
    } catch (e) {
      console.error(e);
      statusEl.textContent = "error: " + e.message;
      await end();
    }
  }

  async function end() {
    try {
      pc && pc.close();
      mic && mic.getTracks().forEach(t => t.stop());
    } catch {}
    startBtn.disabled = false; endBtn.disabled = true;
    statusEl.textContent = "idle";
  }

  startBtn.addEventListener("click", start);
  endBtn.addEventListener("click", end);
})();
</script>
